name: Build and Package for Microsoft Store

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      create_msix:
        description: 'Create MSIX package'
        required: false
        default: 'true'
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binaries
        run: cargo build --release

      - name: Prepare MSIX directory structure
        run: |
          New-Item -ItemType Directory -Force -Path msix-content
          New-Item -ItemType Directory -Force -Path msix-content\assets\store
          
          # Copy binaries
          Copy-Item target\release\dndgamerolls.exe msix-content\
          Copy-Item target\release\dice3d.exe msix-content\
          
          # Copy app manifest
          Copy-Item packaging\msix\AppxManifest.xml msix-content\
          
          # Copy assets if they exist
          if (Test-Path assets\store) {
            Copy-Item -Recurse assets\store\* msix-content\assets\store\
          }
          
          # Copy character sheet
          Copy-Item dnd_stats.json msix-content\

      - name: Create placeholder store assets (if missing)
        run: |
          $storeDir = "msix-content\assets\store"
          
          # Create placeholder images if they don't exist
          # In production, replace these with actual assets
          $sizes = @{
            "StoreLogo.png" = "50x50"
            "Square44x44Logo.png" = "44x44"
            "Square150x150Logo.png" = "150x150"
            "Square310x310Logo.png" = "310x310"
            "Wide310x150Logo.png" = "310x150"
            "SplashScreen.png" = "620x300"
          }
          
          foreach ($file in $sizes.Keys) {
            $path = Join-Path $storeDir $file
            if (-not (Test-Path $path)) {
              Write-Host "Warning: Missing store asset: $file - MSIX packaging will fail without proper assets"
            }
          }

      - name: Install Windows SDK (for makeappx)
        run: |
          # makeappx.exe is included in Windows SDK
          # Check if it exists in common locations
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64"
          if (Test-Path $sdkPath) {
            echo "$sdkPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Create MSIX package (unsigned)
        if: github.event.inputs.create_msix == 'true' || github.event_name == 'release'
        run: |
          # Create the MSIX package
          makeappx pack /d msix-content /p GameRoll_${{ github.ref_name }}_x64.msix /nv
        continue-on-error: true

      - name: Upload release binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            target/release/dndgamerolls.exe
            target/release/dice3d.exe

      - name: Upload MSIX package
        if: github.event.inputs.create_msix == 'true' || github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: msix-package
          path: "*.msix"
          if-no-files-found: warn

      - name: Attach binaries to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/release/dndgamerolls.exe
            target/release/dice3d.exe
            *.msix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Submit to Microsoft Store (requires Partner Center API setup)
  # submit-to-store:
  #   name: Submit to Microsoft Store
  #   needs: build-windows
  #   runs-on: windows-latest
  #   if: github.event_name == 'release'
  #   steps:
  #     - name: Download MSIX
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: msix-package
  #     
  #     - name: Submit to Partner Center
  #       uses: microsoft/store-submission@v1
  #       with:
  #         command: publish
  #         productId: ${{ secrets.MS_STORE_PRODUCT_ID }}
  #         packagePath: "*.msix"
  #         tenantId: ${{ secrets.AZURE_TENANT_ID }}
  #         clientId: ${{ secrets.AZURE_CLIENT_ID }}
  #         clientSecret: ${{ secrets.AZURE_CLIENT_SECRET }}
